name: Nightly CI

# Run weekly to test against pre-release versions for early warning
# Failures here don't block releases - they indicate upcoming work needed
on:
  schedule:
    # Run every Monday at 2 AM UTC
    - cron: '0 2 * * 1'
  workflow_dispatch: # Allow manual triggering

jobs:
  nightly:
    runs-on: ${{ matrix.os }}
    continue-on-error: true # Don't fail the workflow if pre-release versions break
    strategy:
      fail-fast: false
      matrix:
        os: ["ubuntu-latest", "macos-latest", "windows-latest"]
        lean-version: ["nightly"]
        zig-version: ["master"]

    name: ${{ matrix.os }} / Lean ${{ matrix.lean-version }} / Zig ${{ matrix.zig-version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Zig master
        if: matrix.zig-version == 'master'
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            curl -L https://ziglang.org/builds/zig-linux-x86_64-0.15.0-dev.2057+d61dd22f5.tar.xz | tar xJ
            echo "$PWD/zig-linux-x86_64-0.15.0-dev.2057+d61dd22f5" >> $GITHUB_PATH
          elif [ "$RUNNER_OS" == "macOS" ]; then
            curl -L https://ziglang.org/builds/zig-macos-aarch64-0.15.0-dev.2057+d61dd22f5.tar.xz | tar xJ
            echo "$PWD/zig-macos-aarch64-0.15.0-dev.2057+d61dd22f5" >> $GITHUB_PATH
          fi
        shell: bash

      - name: Install Zig master (Windows)
        if: matrix.zig-version == 'master' && runner.os == 'Windows'
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://ziglang.org/builds/zig-windows-x86_64-0.15.0-dev.2057+d61dd22f5.zip" -OutFile zig.zip
          Expand-Archive -Path zig.zip -DestinationPath .
          echo "$PWD\zig-windows-x86_64-0.15.0-dev.2057+d61dd22f5" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Install Elan (Unix)
        if: runner.os != 'Windows'
        run: |
          curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y --default-toolchain none
          echo "$HOME/.elan/bin" >> $GITHUB_PATH

      - name: Install Elan (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $env:ELAN_HOME = "$env:USERPROFILE\.elan"
          curl -O --location https://raw.githubusercontent.com/leanprover/elan/master/elan-init.ps1
          .\elan-init.ps1 -NoPrompt $true -DefaultToolchain none
          echo "$env:USERPROFILE\.elan\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Install Lean nightly (Unix)
        if: runner.os != 'Windows' && matrix.lean-version == 'nightly'
        run: |
          elan toolchain install nightly
          elan default nightly

      - name: Install Lean nightly (Windows)
        if: runner.os == 'Windows' && matrix.lean-version == 'nightly'
        shell: pwsh
        run: |
          elan toolchain install nightly
          elan default nightly

      - name: Update Lake manifest (Unix)
        if: runner.os != 'Windows'
        run: lake update

      - name: Update Lake manifest (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: lake update

      - name: Build (Unix)
        if: runner.os != 'Windows'
        run: zig build

      - name: Build (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $leanPath = lean --print-prefix
          $env:PATH = "$leanPath\bin;$env:PATH"
          zig build

      - name: Test (Unix)
        if: runner.os != 'Windows'
        run: zig build test

      - name: Test (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $leanPath = lean --print-prefix
          $env:PATH = "$leanPath\bin;$env:PATH"
          zig build test

      - name: Report Status
        if: always()
        run: |
          echo "::notice title=Nightly Build::This is a nightly build against pre-release versions. Failures here are for early warning only and don't block releases."
