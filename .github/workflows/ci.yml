name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      # Run all matrix combinations even if some fail, to identify which specific OS/Lean/Zig combinations have issues
      fail-fast: false
      matrix:
        # PRs: Test one Windows and one Linux config for fast feedback (2 jobs)
        # Main: Full matrix (12 jobs for comprehensive testing)
        os: ${{ github.event_name == 'pull_request' && fromJSON('["ubuntu-latest", "windows-latest"]') || fromJSON('["ubuntu-latest", "macos-latest", "windows-latest"]') }}
        lean-version: ${{ github.event_name == 'pull_request' && fromJSON('["4.26.0"]') || fromJSON('["4.25.0", "4.26.0"]') }}
        zig-version: ${{ github.event_name == 'pull_request' && fromJSON('["0.15.2"]') || fromJSON('["0.14.0", "0.15.2"]') }}

    name: ${{ matrix.os }} / Lean ${{ matrix.lean-version }} / Zig ${{ matrix.zig-version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: ${{ matrix.zig-version }}

      - name: Install Elan (Unix)
        if: runner.os != 'Windows'
        run: |
          curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y --default-toolchain none
          echo "$HOME/.elan/bin" >> $GITHUB_PATH

      - name: Install Elan (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $env:ELAN_HOME = "$env:USERPROFILE\.elan"
          curl -O --location https://raw.githubusercontent.com/leanprover/elan/master/elan-init.ps1
          .\elan-init.ps1 -NoPrompt $true -DefaultToolchain none
          echo "$env:USERPROFILE\.elan\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Install Lean toolchain (Unix)
        if: runner.os != 'Windows'
        run: |
          source $HOME/.elan/env
          elan toolchain install leanprover/lean4:v${{ matrix.lean-version }}
          elan default leanprover/lean4:v${{ matrix.lean-version }}

      - name: Install Lean toolchain (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          elan toolchain install leanprover/lean4:v${{ matrix.lean-version }}
          elan default leanprover/lean4:v${{ matrix.lean-version }}

      - name: Update Lake manifest (Unix)
        if: runner.os != 'Windows'
        run: |
          source $HOME/.elan/env
          lake update

      - name: Update Lake manifest (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: lake update

      - name: Build (Unix)
        if: runner.os != 'Windows'
        run: |
          source $HOME/.elan/env
          lake build

      - name: Build (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: lake build

      - name: Test (Unix)
        if: runner.os != 'Windows'
        run: |
          source $HOME/.elan/env
          lake script run test

      - name: Test (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: lake script run test
